async function addWorkflowRule(req, res) {
  const prisma = req.prisma;
  const role_id = req.role_id;
  console.log("body : ", req.body);
  const obj = req.body.find((i) => i.workFlowName);
  const workflowname = obj?.workFlowName;
  const ruledata = req.body.filter((i) => !i.workFlowName);
  console.log("flwo name ", workflowname);
  try {
    if (role_id === 104) {
      console.log("workflowname", workflowname);
      const workflowId = await prisma.$queryRaw`
  SELECT id FROM "Workflow" WHERE workflow_name = ${workflowname}`;

      const roleid = await prisma.$queryRaw`
  SELECT role_id FROM "Role" WHERE name = ${task.aprroveBy}`;

      const response = await prisma.$transaction([
        await prisma.workflow.create({
          data: {
            workflow_name: workflowname,
          },
        }),

        Promise.all(
          ruledata.map(async (task, i) => {
            if (task.initialState === null || task.aprroveby === null) {
              return;
            }

            const response = await prisma.Workflow_Rules.create({
              data: {
                state_1: task.initialState,
                role_id: roleid[0]?.role_id,
                state_2: task.endState,
                workflow_id: workflowId[0]?.id,
              },
            });
            return response;
          }),
        ),
      ]);

      if (response) {
        res.status(200).send({ message: "Rule created " });
      }
    }
  } catch (err) {
    console.log(err);
    res.status(500).send({ message: "error adding Workflow", err: err });
  }
}

module.exports = { addWorkflowRule };
